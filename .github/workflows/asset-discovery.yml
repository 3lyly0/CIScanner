name: Asset Discovery & Intelligence Gathering

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain for deep recon'
        required: true
        default: 'example.com'
  schedule:
    # Runs every Sunday at 7 AM UTC (a day after the vulnerability scan)
    - cron: '0 7 * * 0'

jobs:
  recon:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Dependencies & Tools
        run: |
          # Update package list and install system-level dependencies
          sudo apt-get update
          sudo apt-get install -y chromium-browser jq libpcap-dev unzip curl

      # --- FINAL FIX: USING GITHUB TOKEN FOR RELIABLE API CALLS ---
      - name: Install ProjectDiscovery Tools (Manual Method)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest version of pdtm using the token for reliability
          PDTM_VERSION=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/repos/projectdiscovery/pdtm/releases/latest | jq -r '.tag_name')
          echo "Installing pdtm version: $PDTM_VERSION"
          
          # Download the pdtm binary for linux amd64
          curl -sL "https://github.com/projectdiscovery/pdtm/releases/download/${PDTM_VERSION}/pdtm_${PDTM_VERSION#v}_linux_amd64.zip" -o pdtm.zip
          
          # Unzip and install
          unzip -o pdtm.zip
          sudo mv pdtm /usr/local/bin/
          sudo chmod +x /usr/local/bin/pdtm
          
          # Install the tools using the pdtm utility
          sudo pdtm -install subfinder
          sudo pdtm -install naabu
          sudo pdtm -install httpx
          
          # --- CRITICAL FIX: ADD THE CORRECT PATH FOR PDTM TOOLS ---
          echo "/root/.pdtm/go/bin" >> $GITHUB_PATH
          echo "/usr/local/bin" >> $GITHUB_PATH

      # --- NEW ROBUST INSTALLATION METHOD (API-BASED DOWNLOAD) ---
      - name: Install Other Tools (Simple Go Install & API Download)
        run: |
          # Install Go for tools that need it
          sudo apt-get install -y golang-go
          
          # Install waybackurls using the simple and reliable method
          echo "Installing waybackurls from tomnomnom..."
          go install github.com/tomnomnom/waybackurls@latest
          
          # Install gowitness using the API to get the direct download URL (MOST RELIABLE METHOD)
          echo "Fetching gowitness download URL from API..."
          GOWITNESS_DOWNLOAD_URL=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/sensepost/gowitness/releases/latest | jq -r '.assets[] | select(.name == "gowitness_linux_amd64.tar.gz") | .browser_download_url')
          echo "Downloading gowitness from: $GOWITNESS_DOWNLOAD_URL"
          curl -sL "$GOWITNESS_DOWNLOAD_URL" -o gowitness.tar.gz
          tar -xzf gowitness.tar.gz
          # The extracted directory name will be gowitness-<version>-linux-amd64
          sudo mv gowitness-*/gowitness /usr/local/bin/
          sudo chmod +x /usr/local/bin/gowitness
          
          # Add Go's bin path to the PATH
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Set Domain
        id: set_domain
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "DOMAIN=${{ github.event.inputs.domain }}" >> $GITHUB_ENV
          else
            echo "DOMAIN=example.com" >> $GITHUB_ENV
          fi

      - name: Create Notification Script
        run: |
          cat << 'EOF' > notify.sh
          #!/bin/bash
          set -e
          WEBHOOK_URL="$1"
          DOMAIN="$2"

          send_embed() {
              local title="$1"
              local description="$2"
              local color="$3"
              local payload
              payload=$(jq -n \
                  --arg title "$title" \
                  --arg description "$description" \
                  --argjson color "$color" \
                  --arg footer "Recon completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
                  '{
                      "embeds": [{
                          "title": $title,
                          "description": $description,
                          "color": $color,
                          "footer": {"text": $footer}
                      }]
                  }')
              curl -s -H "Content-Type: application/json" -X POST -d "$payload" "$WEBHOOK_URL"
          }

          case "$3" in
            "start")
              send_embed "üó∫Ô∏è Deep Recon Started" "**Target:** $DOMAIN\n**Tools:** Subfinder, Naabu, Httpx, Gowitness, Waybackurls" "3447003"
              ;;
            "summary")
              printf -v desc '**Target:** %s\n\n**üìä Discovery Summary:**\n- **Subdomains Found:** %s\n- **Open Ports Found:** %s\n- **Live Web Services:** %s\n- **Screenshots Taken:** %s\n- **Wayback URLs Gathered:** %s\n\nüì¶ Detailed reports and screenshots are available in the [GitHub Actions artifacts](%s).' \
                "$DOMAIN" "$4" "$5" "$6" "$7" "$8" "$9"
              send_embed "üìã Recon Report for $DOMAIN" "$desc" "10181038"
              ;;
          esac
          EOF
          chmod +x notify.sh

      - name: Notify Start
        run: |
          ./notify.sh "${{ secrets.DISCORD_WEBHOOK }}" "${{ env.DOMAIN }}" "start"

      - name: 1Ô∏è‚É£ Subdomain Enumeration
        run: |
          echo "üîç Enumerating subdomains for ${{ env.DOMAIN }}..."
          subfinder -d ${{ env.DOMAIN }} -silent -o subdomains.txt
          echo "SUBDOMAINS_COUNT=$(wc -l < subdomains.txt)" >> $GITHUB_ENV

      - name: 2Ô∏è‚É£ Port Scanning
        run: |
          echo "üöÄ Scanning ports on discovered subdomains..."
          naabu -list subdomains.txt -silent -top-ports 1000 -o ports.txt
          echo "PORTS_COUNT=$(wc -l < ports.txt)" >> $GITHUB_ENV

      - name: 3Ô∏è‚É£ Probing & Technology Identification
        run: |
          echo "üåê Probing for live web services and identifying technologies..."
          cat ports.txt | httpx -silent -title -tech-detect -status-code -o live-services.txt
          echo "LIVE_SERVICES_COUNT=$(wc -l < live-services.txt)" >> $GITHUB_ENV

      - name: 4Ô∏è‚É£ Screenshotting Live Services
        run: |
          echo "üì∏ Taking screenshots of live web services..."
          mkdir -p screenshots
          # gowitness needs a list of full URLs
          cat live-services.txt | awk '{print $1}' | gowitness file -f - -P ./screenshots --disable-logging
          echo "SCREENSHOTS_COUNT=$(ls -1q screenshots | wc -l)" >> $GITHUB_ENV

      - name: 5Ô∏è‚É£ Wayback URL Gathering
        run: |
          echo "üï∞Ô∏è Gathering URLs from Wayback Machine..."
          waybackurls ${{ env.DOMAIN }} | sort -u > wayback-urls.txt
          echo "WAYBACK_COUNT=$(wc -l < wayback-urls.txt)" >> $GITHUB_ENV

      - name: Notify Final Summary
        env:
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          ./notify.sh "${{ secrets.DISCORD_WEBHOOK }}" "${{ env.DOMAIN }}" "summary" \
            "${{ env.SUBDOMAINS_COUNT }}" \
            "${{ env.PORTS_COUNT }}" \
            "${{ env.LIVE_SERVICES_COUNT }}" \
            "${{ env.SCREENSHOTS_COUNT }}" \
            "${{ env.WAYBACK_COUNT }}" \
            "${{ env.GITHUB_RUN_URL }}"

      - name: Upload Recon Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: recon-report-${{ env.DOMAIN }}-${{ github.run_number }}
          path: |
            subdomains.txt
            ports.txt
            live-services.txt
            wayback-urls.txt
          retention-days: 30

      - name: Upload Screenshots as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ env.DOMAIN }}-${{ github.run_number }}
          path: screenshots/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          rm -rf notify.sh subdomains.txt ports.txt live-services.txt wayback-urls.txt screenshots/
